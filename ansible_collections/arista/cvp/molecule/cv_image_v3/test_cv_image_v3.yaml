---
- name: Test cv_image_v3
  hosts: CloudVision
  connection: local
  gather_facts: no
  vars:
    # Make sure given image does not exist on CVP
    image_name: "EOS-4.25.4M.swi"
  tasks:

  ### Run all the tasks sequentially ###

    - name: "Create bundle {{inventory_hostname}}"
      vars:
        ansible_command_timeout: 1200
        ansible_connect_timeout: 600
      arista.cvp.cv_image_v3:
        mode: bundle
        action: add
        bundle_name: Test_bundle
        image_list:
          - "{{image_name}}"
      register: CREATE_BUNDLE_DATA
    - name: "Gather CVP bundle information facts {{inventory_hostname}}"
      vars:
        ansible_command_timeout: 1200
        ansible_connect_timeout: 600
      arista.cvp.cv_image_v3:
        mode: bundle
        action: get
      register: BUNDLE_DATA
    - assert:
        that:
          - CREATE_BUNDLE_DATA.changed == true
          - CREATE_BUNDLE_DATA.data.data == "Bundle : Test_bundle successfully created"
          - CREATE_BUNDLE_DATA.failed == false
          - BUNDLE_DATA.changed == false
          - BUNDLE_DATA.data.bundles[0].name == "Test_bundle"
          - BUNDLE_DATA.data.bundles[0].imageIds == ["{{image_name}}"]

    - name: "Update bundle {{inventory_hostname}}"
      vars:
        ansible_command_timeout: 1200
        ansible_connect_timeout: 600
      arista.cvp.cv_image_v3:
        mode: bundle
        action: add
        bundle_name: Test_bundle
        image_list:
          - "{{image_name}}"
      register: UPDATE_BUNDLE_DATA
    - assert:
        that:
          - UPDATE_BUNDLE_DATA.changed == true
          - UPDATE_BUNDLE_DATA.data.data == "Image bundle updated successfully."
          - UPDATE_BUNDLE_DATA.failed == false

    - name: "Delete bundle {{inventory_hostname}}"
      vars:
        ansible_command_timeout: 1200
        ansible_connect_timeout: 600
      arista.cvp.cv_image_v3:
        mode: bundle
        action: remove
        bundle_name: Test_bundle
        image_list:
          - "{{image_name}}"
      register: DELETE_BUNDLE
    - name: "Gather CVP bundle information facts {{inventory_hostname}}"
      vars:
        ansible_command_timeout: 1200
        ansible_connect_timeout: 600
      arista.cvp.cv_image_v3:
        mode: bundle
        action: get
      register: DELETED_BUNDLE_DATA
    - assert:
        that:
          - DELETE_BUNDLE.changed == true
          - DELETE_BUNDLE.data.data == "success"
          - DELETE_BUNDLE.failed == false
          - DELETED_BUNDLE_DATA.data.bundles[0].name != "Test_bundle"
          - DELETED_BUNDLE_DATA.data.bundles[0].imageIds != ["{{image_name}}"]

    - name: "Negative test: Create bundle with multiple images {{inventory_hostname}}"
      vars:
        ansible_command_timeout: 1200
        ansible_connect_timeout: 600
      arista.cvp.cv_image_v3:
        mode: bundle
        action: add
        bundle_name: Test_bundle
        image_list:
          - "{{image_name}}"
          - "{{image_name}}"
      ignore_errors: yes
      register: NEGATIVE_BUNDLE_DATA
    - assert:
        that:
          - NEGATIVE_BUNDLE_DATA.changed == false
          - NEGATIVE_BUNDLE_DATA.msg == "Request Error: Failure - Only one swi image can be uploaded per bundle."

    - name: "Add an image {{inventory_hostname}}"
      vars:
        ansible_command_timeout: 1200
        ansible_connect_timeout: 600
      arista.cvp.cv_image_v3:
        mode: image
        action: add
        image: "{{image_name}}"
      register: ADD_IMAGE
    - name: "Gather CVP image information facts {{inventory_hostname}}"
      vars:
        ansible_command_timeout: 1200
        ansible_connect_timeout: 600
      arista.cvp.cv_image_v3:
        mode: image
        action: get
      register: IMAGE_DATA
    - assert:
        that:
          - ADD_IMAGE.changed == true
          - ADD_IMAGE.data.result == "success"
          - ADD_IMAGE.data.imageId == "{{image_name}}"
          - ADD_IMAGE.data.name == "{{image_name}}"
          - ADD_IMAGE.failed == false
          - IMAGE_DATA.data.images[0].imageFileName == "{{image_name}}"
          - IMAGE_DATA.data.images[0].imageId == "{{image_name}}"
          - IMAGE_DATA.data.images[0].name == "{{image_name}}"

    - name: "Negative test: Add image already exists {{inventory_hostname}}"
      vars:
        ansible_command_timeout: 1200
        ansible_connect_timeout: 600
      arista.cvp.cv_image_v3:
        mode: image
        action: add
        image: "{{image_name}}"
      ignore_errors: yes
      register: NEGATIVE_ADD_IMAGE
    - assert:
        that:
          - NEGATIVE_ADD_IMAGE.changed == false
          - NEGATIVE_ADD_IMAGE.data == {}
          - NEGATIVE_ADD_IMAGE.failed == false

#####################################################################
##### Deletion of images through API is not supported currently #####
#####################################################################

    - name: "Negative test: Delete an image {{inventory_hostname}}"
      vars:
        ansible_command_timeout: 1200
        ansible_connect_timeout: 600
      arista.cvp.cv_image_v3:
        mode: image
        action: remove
        image: "{{image_name}}"
      ignore_errors: yes
      register: DELETE_IMAGE
    - assert:
        that:
          - DELETE_IMAGE.changed == false
          - DELETE_IMAGE.msg == "Deletion of images through API is not currently supported"
